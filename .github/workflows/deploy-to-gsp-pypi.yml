name: Deploy to GSP pypi Workflow

on:
  workflow_call:
    inputs:
      python_version:
        description: "The version of Python to use for testing and linting"
        type: string
        required: false
        default: "3.9"

      ruff_version:
        description: "Version of Ruff to use (defaults to version in uv.lock if found)"
        type: string
        required: false
        default: ""

      mypy_version:
        description: "Version of MyPy to use (defaults to version in uv.lock if found)"
        type: string
        required: false
        default: ""

      uv_lock_path:
        description: "Path to uv.lock file (defaults to ./uv.lock)"
        type: string
        required: false
        default: "./uv.lock"

      working_directory:
        description: "Working directory for the Python project (useful for monorepos)"
        type: string
        required: false
        default: "."

      use_dvc:
        description: "Whether to use DVC to pull data. Expects AWS credentials to be set in the repository secrets."
        type: boolean
        required: false
        default: false

      dvc_version:
        description: "Version of DVC to install. If not set, will use latest version."
        type: string
        required: false
        default: ""

      use_private_pypi:
        description: "Whether to use the private GSP PyPI server. Set to false for repos that don't need private packages."
        type: boolean
        required: false
        default: true

jobs:
  trigger_test:
    uses: gold-standard-phantoms/github-actions/.github/workflows/python-test.yml@v0.3.0
    with:
      python_version: ${{ inputs.python_version }}
      ruff_version: ${{ inputs.ruff_version }}
      mypy_version: ${{ inputs.mypy_version }}
      uv_lock_path: ${{ inputs.uv_lock_path }}
      working_directory: ${{ inputs.working_directory }}
      use_dvc: ${{ inputs.use_dvc }}
      dvc_version: ${{ inputs.dvc_version }}
      use_private_pypi: ${{ inputs.use_private_pypi }}
    secrets: inherit

  build_and_deploy:
    name: Build and Deploy
    needs: [trigger_test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    if: ${{ needs.trigger_test.result == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - uses: gold-standard-phantoms/github-actions/.github/actions/build-and-deploy-pypi@v0.3.0
        with:
          pypi_username: ${{ secrets.PRIVATE_PYPI_USERNAME }}
          pypi_password: ${{ secrets.PRIVATE_PYPI_PASSWORD }}
          pypi_url: ${{ secrets.PRIVATE_PYPI_URL }}
          working_directory: ${{ inputs.working_directory }}
